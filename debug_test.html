<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dec207Hub Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .debug-box { border: 1px solid #0f0; padding: 10px; margin: 10px 0; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        button { background: #0f0; color: #000; border: none; padding: 8px 16px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Dec207Hub ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸</h1>
    




    
    <div class="debug-box">
        <h3>1. ê¸°ë³¸ ì„¤ì • í™•ì¸</h3>
        <div id="basic-status">ê²€ì‚¬ ì¤‘...</div>
    </div>
    
    <div class="debug-box">
        <h3>2. ë°±ì—”ë“œ ì—°ê²° í™•ì¸</h3>
        <div id="backend-status">ê²€ì‚¬ ì¤‘...</div>
        <button onclick="testBackend()">ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸</button>
    </div>
    
    <div class="debug-box">
        <h3>3. WebSocket ì—°ê²° í™•ì¸</h3>
        <div id="websocket-status">ê²€ì‚¬ ì¤‘...</div>
        <button onclick="testWebSocket()">WebSocket í…ŒìŠ¤íŠ¸</button>
    </div>
    
    <div class="debug-box">
        <h3>4. JavaScript ì˜¤ë¥˜ í™•ì¸</h3>
        <div id="js-errors">ê²€ì‚¬ ì¤‘...</div>
        <button onclick="testJavaScript()">JS í…ŒìŠ¤íŠ¸</button>
    </div>
    
    <div class="debug-box">
        <h3>5. ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸</h3>
        <input type="text" id="test-message" placeholder="í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì…ë ¥" style="width: 300px; padding: 8px;">
        <button onclick="sendTestMessage()">ì „ì†¡ í…ŒìŠ¤íŠ¸</button>
        <div id="message-result"></div>
    </div>
    
    <div class="debug-box">
        <h3>6. ë¡œê·¸ í™•ì¸</h3>
        <div id="log-output" style="max-height: 200px; overflow-y: auto; background: #111; padding: 10px;"></div>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <script>
        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function clearLog() {
            document.getElementById('log-output').innerHTML = '';
        }

        // 1. ê¸°ë³¸ ì„¤ì • í™•ì¸
        function checkBasicSetup() {
            const basicDiv = document.getElementById('basic-status');
            let status = '';
            
            // í˜„ì¬ URL í™•ì¸
            status += `ğŸ“ í˜„ì¬ URL: ${window.location.href}\n`;
            
            // localStorage í™•ì¸
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                status += `âœ… localStorage ì‚¬ìš© ê°€ëŠ¥\n`;
            } catch (e) {
                status += `âŒ localStorage ì‚¬ìš© ë¶ˆê°€: ${e.message}\n`;
            }
            
            // ë¸Œë¼ìš°ì € ì •ë³´
            status += `ğŸŒ ë¸Œë¼ìš°ì €: ${navigator.userAgent.substring(0, 50)}...\n`;
            
            basicDiv.innerHTML = `<pre>${status}</pre>`;
            log('ê¸°ë³¸ ì„¤ì • í™•ì¸ ì™„ë£Œ');
        }

        // 2. ë°±ì—”ë“œ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testBackend() {
            const backendDiv = document.getElementById('backend-status');
            backendDiv.innerHTML = 'â³ ë°±ì—”ë“œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            try {
                // ì„œë²„ IP ìë™ ê°ì§€
                let serverIP = 'localhost';
                if (window.location.protocol !== 'file:' && 
                    window.location.hostname !== 'localhost' && 
                    window.location.hostname !== '127.0.0.1') {
                    serverIP = window.location.hostname;
                }
                
                const healthUrl = `http://${serverIP}:8000/health`;
                log(`ë°±ì—”ë“œ URL: ${healthUrl}`);
                
                const response = await fetch(healthUrl);
                const data = await response.json();
                
                let status = `âœ… ë°±ì—”ë“œ ì—°ê²° ì„±ê³µ\n`;
                status += `ğŸ“Š ì„œë²„ ìƒíƒœ: ${data.server}\n`;
                status += `ğŸ¤– Ollama: ${data.ollama}\n`;
                status += `ğŸ”— í™œì„± ì—°ê²°: ${data.active_connections}\n`;
                status += `â° ì‹œê°„: ${data.timestamp}\n`;
                
                backendDiv.innerHTML = `<pre class="success">${status}</pre>`;
                log('ë°±ì—”ë“œ ì—°ê²° ì„±ê³µ', 'success');
                
            } catch (error) {
                const errorMsg = `âŒ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                backendDiv.innerHTML = `<pre class="error">${errorMsg}</pre>`;
                log(`ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // 3. WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸
        function testWebSocket() {
            const wsDiv = document.getElementById('websocket-status');
            wsDiv.innerHTML = 'â³ WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            
            // ì„œë²„ IP ìë™ ê°ì§€
            let serverIP = 'localhost';
            if (window.location.protocol !== 'file:' && 
                window.location.hostname !== 'localhost' && 
                window.location.hostname !== '127.0.0.1') {
                serverIP = window.location.hostname;
            }
            
            const wsUrl = `ws://${serverIP}:8000/ws`;
            log(`WebSocket URL: ${wsUrl}`);
            
            const testWs = new WebSocket(wsUrl);
            
            testWs.onopen = () => {
                wsDiv.innerHTML = '<pre class="success">âœ… WebSocket ì—°ê²° ì„±ê³µ</pre>';
                log('WebSocket ì—°ê²° ì„±ê³µ', 'success');
                
                // í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
                const testMessage = {
                    message: "ì—°ê²° í…ŒìŠ¤íŠ¸",
                    model: "llama3.1:8b",
                    conversation_history: [],
                    timestamp: new Date().toISOString()
                };
                
                testWs.send(JSON.stringify(testMessage));
                log('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ë¨');
            };
            
            testWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`WebSocket ì‘ë‹µ: ${data.type} - ${data.message?.substring(0, 50)}...`, 'success');
                testWs.close();
            };
            
            testWs.onerror = (error) => {
                wsDiv.innerHTML = `<pre class="error">âŒ WebSocket ì—°ê²° ì‹¤íŒ¨</pre>`;
                log(`WebSocket ì˜¤ë¥˜: ${error}`, 'error');
            };
            
            testWs.onclose = () => {
                log('WebSocket ì—°ê²° ì¢…ë£Œ');
            };
        }

        // 4. JavaScript í…ŒìŠ¤íŠ¸
        function testJavaScript() {
            const jsDiv = document.getElementById('js-errors');
            
            try {
                // Dec207Hub í´ë˜ìŠ¤ ì¡´ì¬ í™•ì¸
                if (typeof Dec207Hub === 'undefined') {
                    throw new Error('Dec207Hub í´ë˜ìŠ¤ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ');
                }
                
                // DOM ìš”ì†Œ í™•ì¸
                const requiredElements = [
                    '.dec207-input-field',
                    '.dec207-btn.primary',
                    '.dec207-chat-messages'
                ];
                
                let status = 'âœ… JavaScript ê¸°ë³¸ ì²´í¬ í†µê³¼\n';
                
                requiredElements.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        status += `âœ… ${selector} ìš”ì†Œ ì¡´ì¬\n`;
                    } else {
                        status += `âŒ ${selector} ìš”ì†Œ ì—†ìŒ\n`;
                    }
                });
                
                jsDiv.innerHTML = `<pre>${status}</pre>`;
                log('JavaScript í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
                
            } catch (error) {
                jsDiv.innerHTML = `<pre class="error">âŒ JavaScript ì˜¤ë¥˜: ${error.message}</pre>`;
                log(`JavaScript ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // 5. ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸
        function sendTestMessage() {
            const messageInput = document.getElementById('test-message');
            const resultDiv = document.getElementById('message-result');
            const message = messageInput.value.trim();
            
            if (!message) {
                resultDiv.innerHTML = '<span class="warning">âš ï¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>';
                return;
            }
            
            resultDiv.innerHTML = 'â³ ë©”ì‹œì§€ ì „ì†¡ ì¤‘...';
            log(`í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡: ${message}`);
            
            // ì‹œë®¬ë ˆì´ì…˜ëœ ë©”ì‹œì§€ ì „ì†¡
            setTimeout(() => {
                resultDiv.innerHTML = '<span class="success">âœ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ (ì‹œë®¬ë ˆì´ì…˜)</span>';
                log('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ', 'success');
                messageInput.value = '';
            }, 1000);
        }

        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            log('ë””ë²„ê·¸ í˜ì´ì§€ ë¡œë“œë¨');
            checkBasicSetup();
            
            // ìë™ìœ¼ë¡œ ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            setTimeout(testBackend, 1000);
        });

        // ì˜¤ë¥˜ ìºì¹˜
        window.addEventListener('error', (e) => {
            log(`JavaScript ì˜¤ë¥˜: ${e.error}`, 'error');
        });
    </script>
</body>
</html>