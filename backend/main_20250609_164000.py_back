# Dec207Hub Backend API Server
# FastAPI + Ollama 연동 서버

from fastapi import FastAPI, WebSocket, WebSocketDisconnect, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
import json
import httpx
import asyncio
import os
from datetime import datetime
from typing import List, Dict, Any
import logging
import re
import hashlib
from fastapi.responses import FileResponse
from mcp_manager import get_mcp_tools, execute_mcp_tool

# 로깅 설정
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="Dec207Hub API", version="1.0.0")

# Ollama 설정
OLLAMA_BASE_URL = "http://localhost:11434"
DEFAULT_MODEL = "llama3.1:8b"  # 설치된 모델에 맞춤

# WebSocket 엔드포인트를 정적 파일 마운트보다 먼저 정의하여 우선순위를 높임
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    """WebSocket을 통한 실시간 채팅 - 메시지 중복 방지 개선"""
    await manager.connect(websocket)
    
    # 클라이언트 IP 추출
    user_ip = chat_logger